<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover">
    <title>Orient Finance Co-Browse</title>
    <link rel="icon" href="/static/orient-finance-logo.png" type="image/png">
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="/static/laplace-legacy.css?v=4">
    <script src="/static/config.js"></script>
</head>
<body>

<nav class="navbar">
    <a class="navbar-brand" href="/srm">
      <img src="/static/orient-finance-logo.png" alt="Orient Finance" class="navbar-logo">
      <span class="navbar-title">Orient Finance Co-Browse</span>
    </a>
    <span class="navbar-brand header-room" id="room-text"></span>
    <a href="/logout" class="navbar-logout" id="navbar-logout" style="display:none;">Logout</a>
</nav>

<div class="container">
    <div class="panel" id="panel">
        <p class="help-text">
            Share your screen securely with your Sales Relationship Manager. No installation required — works directly in your browser.
            <a href="https://github.com/oby199/orient-finance-co-browse">Source</a>
        </p>

        <div class="separator"></div>

        <h4>Start sharing your screen</h4>
        <p class="help-text">
            Click the button below to create a new streaming room,
            where you can share your screen with your peers.
            A RoomID will be generated, and you can share the RoomID to your peers.
        </p>
        <button type="button" class="btn btn-dark btn-block" id="btnStream">Start sharing</button>

        <div class="separator"></div>

        <h4>SRM — Create session</h4>
        <p class="help-text">
            Create a secure session and share the link with your client.
        </p>
        <button type="button" class="btn btn-dark btn-block" id="btnCreateSession">Create Session</button>
        <div id="agent-create-error" class="agent-error" role="alert" style="display:none;"></div>
        <div id="agent-link-area" class="agent-link-area" style="display:none;">
            <label for="agentLink" class="help-text">Share this link with your client:</label>
            <div class="input-group mt-1">
                <input type="text" id="agentLink" class="form-control" readonly aria-label="Session link">
                <button type="button" class="btn btn-outline-dark" id="btnCopyLink">Copy</button>
            </div>
            <div class="agent-otp-row mt-2">
                <label class="help-text">Session code (for manual entry):</label>
                <code id="agentSessionCode" class="agent-code"></code>
                <button type="button" class="btn btn-outline-dark btn-sm" id="btnCopyOtp">Copy code</button>
            </div>
            <div id="agent-qr" class="agent-qr mt-2"></div>
            <div class="agent-session-state mt-2">
              <span class="state-badge" id="agent-state">LINK_SENT</span>
              <a href="#" id="agent-view-link" class="btn btn-outline-dark btn-sm ml-2" style="display:none;">View session</a>
            </div>
        </div>

        <div class="separator"></div>

        <h4>Join streaming room</h4>
        <p class="help-text">
            Enter a RoomID to join the streaming room.
            You can get the RoomID from your peer that is doing a screen sharing.
        </p>
        <form id="joinForm">
            <div class="form-group">
                <input id="inputRoomID" type="text" class="form-control form-control-lg text-center" placeholder="Enter room ID" required>
            </div>
            <button type="submit" class="btn btn-dark btn-block" value="submit">Join</button>
        </form>
    </div>
</div>

<!-- Client flow: simple mobile-first UI (shown when coming from /connect) -->
<div id="stream-simple-ui" class="stream-simple-ui" style="display:none;">
  <div class="stream-simple-card">
    <div id="stream-step1" class="stream-step stream-consent-step" style="display:none;">
      <h4 class="stream-consent-title">Client Consent</h4>
      <p class="stream-consent-text" id="streamConsentText">I hereby consent to your Sales Relationship Manager assisting you in completing and submitting your application. Your screen will be shared securely with your SRM only.</p>
      <label class="stream-consent-check">
        <input type="checkbox" id="streamConsentCheck" required>
        <span id="streamConsentLabel">I consent</span>
      </label>
      <button type="button" class="btn-stream-primary" id="btnConsentContinue">Continue</button>
    </div>
    <div id="stream-step2" class="stream-step" style="display:none;">
      <button type="button" class="btn-stream-primary" id="btnStartShareSimple">Start sharing</button>
      <button type="button" class="btn-stream-secondary" id="btnNeedHelp">Need help?</button>
      <div id="stream-compat-msg" class="stream-compat-msg" style="display:none;"></div>
    </div>
    <div id="stream-step3" class="stream-step" style="display:none;">
      <div class="stream-live-pill" aria-live="polite">Live • Sharing</div>
      <p class="stream-connected-msg" id="streamConnectedMsg">Waiting for your SRM to join…</p>
      <button type="button" class="btn-stream-stop" id="btnStopShare">Stop sharing</button>
      <div id="stream-debug-info" class="stream-debug-info" style="display:none;"></div>
    </div>
  </div>
</div>

<!-- Config panel: only visible with ?debug=1 -->
<div class="container container-small" id="stream-serve-page-ui">
    <div class="config-panel">
        <div class="row">
            <div class="col">
                <h4>Screen sharing configuration</h4>
                <p class="help-text">
                    For most people, using the default "balanced" preset is enough,
                    then click the "Start sharing" button to start.
                    For the curious, You may also choose configuration preset that will affect the performance and quality of the streaming.
                    For advance user, you can modify the options inside the textbox directly, please note that it may incur errors.
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for=optionPreset>Preset</label>
                    <br>
                    <select name="optionPreset" id="inputOptionPreset" class="form-control"></select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for=displayMediaOption>DisplayMedia option</label>
                    <textarea name="displayMediaOption" id="inputDisplayMediaOption" cols="30" rows="5" class="form-control"></textarea>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for=RTPPeerConnection>RTPPeerConnection option</label>
                    <textarea name="RTPPeerConnectionOption" id="inputRTPPeerConnectionOption" cols="30" rows="5" class="form-control"></textarea>
                </div>
            </div>
        </div>
        <hr>
        <button type="button" class="btn btn-dark btn-block-xs-only" id="btnStartStream">Start stream</button>
        <span>&nbsp;</span>
        <button type="button" class="btn btn-outline-dark btn-block-xs-only" id="btnStream" onclick="leaveRoom()">Cancel</button>
    </div>
</div>

<!-- Need help bottom sheet -->
<div id="stream-help-sheet" class="stream-help-sheet" role="dialog" aria-label="Help with screen sharing" aria-hidden="true">
  <div class="stream-help-backdrop"></div>
  <div class="stream-help-content">
    <h5>How to share your screen</h5>
    <ul>
      <li><strong>Desktop:</strong> Chrome, Edge, Firefox, or Safari — click "Start sharing", choose screen or tab.</li>
      <li><strong>Android:</strong> Chrome — screen sharing works in some versions.</li>
      <li><strong>iPhone/iPad:</strong> Screen sharing is not supported. Use Safari on a Mac or Windows PC, or Chrome on Android/desktop.</li>
    </ul>
    <p>You need HTTPS (or localhost). If it doesn't work, try refreshing the page.</p>
    <button type="button" class="btn-stream-secondary" id="btnCloseHelp">Close</button>
  </div>
</div>

<div id="client-toast" class="client-toast" role="status" aria-live="polite"></div>

<!-- Error UI: friendly message + Retry (shown on API failure) -->
<div id="error-panel" class="error-panel" style="display:none;" role="alert">
  <div class="error-panel-content">
    <p id="error-panel-message">Something went wrong.</p>
    <button type="button" class="btn btn-dark" id="error-panel-retry">Retry</button>
  </div>
</div>

<!-- Waiting for client (agent viewer, room not yet created) -->
<div id="waiting-for-client" class="waiting-for-client" style="display:none;" role="status">
  <div class="waiting-for-client-content">
    <div class="waiting-status-badge" aria-live="polite">
      <span class="waiting-spinner" aria-hidden="true"></span>
      <span>Waiting</span>
    </div>
    <h4>Waiting for client to connect</h4>
    <p class="help-text">Share the link below with your client. The room will appear once they open the link and click <strong>Start sharing</strong>.</p>
    <div class="waiting-link-wrap">
      <input type="text" id="waiting-connect-link" class="form-control" readonly aria-label="Connect link">
      <button type="button" class="btn btn-dark" id="waiting-copy-link">Copy link</button>
    </div>
    <div class="waiting-code-row">
      <span class="help-text">Or share this code:</span>
      <code id="waiting-session-code" class="waiting-session-code"></code>
      <button type="button" class="btn btn-outline-dark btn-sm" id="waiting-copy-code">Copy code</button>
    </div>
    <div class="waiting-reconnect">
      <span id="waiting-reconnect-msg">Reconnecting automatically…</span>
    </div>
    <button type="button" class="btn btn-outline-dark btn-sm" id="waiting-retry-now">Retry now</button>
  </div>
</div>

<!-- Debug panel: dev only (?debug=1) -->
<div id="debug-panel" class="debug-panel" style="display:none;">
  <small><strong>Debug</strong> route: <span id="debug-route">-</span> | auth: <span id="debug-auth">-</span> | last error: <span id="debug-last-error">-</span></small>
</div>

<div class="container-fluid" id="video-container">
    <div id="video-wrapper" class="video-wrapper-agent">
        <video id="mainVideo" autoplay playsinline controls>
        </video>
        <canvas id="agent-overlay" class="agent-overlay-canvas" aria-hidden="true"></canvas>
        <div id="agent-tools" class="agent-tools">
          <button type="button" class="btn btn-outline-dark btn-sm" id="btnRequestClick" title="Send click request to client">Request click</button>
          <button type="button" class="btn btn-outline-dark btn-sm" id="btnHighlight" title="Draw highlight box (click-drag)">Highlight</button>
          <span class="agent-tool-hint">Hold L for laser · Click-drag for highlight</span>
        </div>
    </div>
</div>

<br><br>

<div class="container container-small" id="stream-page-ui">
    <div id="onboarding-checklist" class="onboarding-checklist">
      <h6>Onboarding steps</h6>
      <ul>
        <li data-step="1"><input type="checkbox" id="step1"> Open registration</li>
        <li data-step="2"><input type="checkbox" id="step2"> Fill personal details</li>
        <li data-step="3"><input type="checkbox" id="step3"> Upload ID</li>
        <li data-step="4"><input type="checkbox" id="step4"> Complete KYC</li>
      </ul>
      <p class="assistant-hint">Need help? Ask your SRM</p>
    </div>
    <div class="row">
        <div class="col-md-9">
            <h4>How to Join this Room</h4>
            <p class="help-text">
                You can share the RoomID to your peers (it is on the top-right position on this page).
                They can also join with the following link or QRCode:
            </p>
            <a href="#" id="join-link" target="_blank"></a>
            <br><br>
        </div>
        <div class="col-md-3">
            <div id="qrcode"></div>
        </div>
    </div>
    <hr>
    <div>
        <h6>Status</h6>
        <table class="table table-borderless table-sm table-meta">
            <tr>
                <td>Number of connections:</td>
                <td id="statusNumConn">0</td>
            </tr>
            <tr>
                <td>Connected peers:</td>
                <td id="statusPeers"></td>
            </tr>
            <tr>
                <td>Ping:</td>
                <td id="statusPing">0 ms</td>
            </tr>
        </table>
        <button type="button" class="btn btn-dark btn-block-xs-only" id="btnStream" onclick="leaveRoom()">Leave Room</button>
    </div>
    <hr>
    <pre id="output"></pre>
</div>

<div class="container">
    <hr>
    <div class="text-center small" id="footer">
        <span>© Orient Finance Broker — Co-Browse</span>
        <a href="#">Security &amp; Privacy</a>
    </div>
</div>

<script src="/static/qrcode.min.js"></script>
<script src="/static/laplace-legacy.js?v=4"></script>
</body>
</html>